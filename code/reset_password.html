<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="estilos/styles_login.css">
    <title>Restablecer Contraseña</title>
</head>
<body>
    <div class="auth-container">
        
        <div class="form-container" style="width: 100%; left: 0; z-index: 5; opacity: 1; min-height: 480px;">
            
            <form id="updatePasswordForm">
                <h1>Nueva Contraseña</h1>
                <p class="subtitle">Ingresa tu nueva contraseña</p>
                
                <div id="mensajeUpdatePass" class="mensaje"></div>
                
                <input type="hidden" id="resetToken" name="token">

                <div class="form-group">
                    <input 
                        type="password" 
                        class="form-control" 
                        id="password" 
                        name="password"
                        placeholder="Nueva contraseña (mín. 6 caracteres)" 
                        required
                        minlength="6"
                    />
                </div>
                <div class="form-group">
                    <input 
                        type="password" 
                        class="form-control" 
                        id="confirm_password" 
                        name="confirm_password"
                        placeholder="Confirmar nueva contraseña" 
                        required
                    />
                </div>
                
                <button type="submit" class="btn-primary" id="btnUpdatePass">
                    Actualizar Contraseña
                </button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Referencias
        const updatePasswordForm = document.getElementById('updatePasswordForm');
        const mensajeUpdatePass = document.getElementById('mensajeUpdatePass');
        const btnUpdatePass = document.getElementById('btnUpdatePass');
        const resetTokenInput = document.getElementById('resetToken');

        // ============================================================
        // 1. OBTENER TOKEN DE LA URL
        // ============================================================
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            mostrarMensaje('Token no encontrado. El enlace es inválido o ha expirado.', 'error');
            btnUpdatePass.disabled = true;
        } else {
            // Guardamos el token en el campo oculto del formulario
            resetTokenInput.value = token;
        }

        // ============================================================
        // 2. MANEJAR ENVÍO DEL FORMULARIO
        // ============================================================
        updatePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const pass = document.getElementById('password').value;
            const confirmPass = document.getElementById('confirm_password').value;

            // Validación simple en el cliente
            if (pass !== confirmPass) {
                mostrarMensaje('Las contraseñas no coinciden', 'error');
                return;
            }

            btnUpdatePass.disabled = true;
            btnUpdatePass.innerHTML = '<span class="spinner-border"></span>ACTUALIZANDO...';
            
            const formData = new FormData(updatePasswordForm);
            
            // Llamamos al último script que nos falta
            fetch('php/actualizar_password.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.message, 'success');
                    btnUpdatePass.disabled = true; // Deshabilitar permanentemente
                    
                    // Redirigir al login después de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    // Mostrar error (ej. "Token expirado")
                    mostrarMensaje(data.message, 'error');
                    btnUpdatePass.disabled = false;
                    btnUpdatePass.innerHTML = 'ACTUALIZAR CONTRASEÑA';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error en la conexión. Intenta nuevamente.', 'error');
                btnUpdatePass.disabled = false;
                btnUpdatePass.innerHTML = 'ACTUALIZAR CONTRASEÑA';
            });
        });

        // ============================================================
        // 3. FUNCIÓN HELPER PARA MENSAJES
        // ============================================================
        function mostrarMensaje(texto, tipo) {
            mensajeUpdatePass.textContent = texto;
            mensajeUpdatePass.className = 'mensaje ' + tipo;
            mensajeUpdatePass.style.display = 'block';
        }
    });
    </script>
</body>
</html>